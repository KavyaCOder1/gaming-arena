<!DOCTYPE html>
<html data-generated-by="stalefish@0.1.0" data-geo="ALL" data-locale="en_ALL" dir="ltr" lang="en">
<head>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code" rel="stylesheet">
    <link href="index.min.css" rel="stylesheet">
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="favicon.svg" rel="icon" type="image/svg+xml">
    <link href="apple-touch-icon-180x180.png" rel="apple-touch-icon">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width, viewport-fit=cover" name="viewport">
    <title>PAC-MAN: Halloween 2025 Edition</title>

    <script>
    (function () {
      'use strict';

      // ── 1. Intercept fetch to inject username into content.json ────────────────
      // The game fetches content.json once at startup to get b.nickname (shown on
      // the intro screen as "CHARACTER / NICKNAME"). We intercept that fetch and
      // replace the nickname with the username passed in from the parent via
      // window.__pacmanUsername (set by the parent page before iframe loads).
      var _origFetch = window.fetch.bind(window);
      window.fetch = function (input, init) {
        var url = (typeof input === 'string') ? input : (input && input.url) || '';
        if (url === 'content.json' || url.indexOf('content.json') !== -1) {
          return _origFetch(input, init).then(function (resp) {
            return resp.json().then(function (data) {
              var username = window.__pacmanUsername || 'PLAYER';
              // content.json → { content: { nickname, character, ... } }
              if (data && data.content) {
                data.content.nickname  = username.toUpperCase();
                data.content.character = 'PAC-MAN';
              }
              var blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
              return new Response(blob, { status: 200, headers: { 'Content-Type': 'application/json' } });
            });
          });
        }
        return _origFetch(input, init);
      };

      // ── 2. Hook into Phaser registry once the game is ready ───────────────────
      // The game web-component is <pcm-game>.  After it renders it has a `.game`
      // property which is the Phaser.Game instance.  We wait for it then attach
      // listeners to Phaser's registry event system.
      //
      // Registry events we care about:
      //   "changedata-currentScene"  → fires with value "game-over" at end
      //   "changedata-score"         → fires whenever score updates (live tracking)
      //   "changedata-currentLevelNumber" → fires when level/stage advances
      //
      var _hooked       = false;
      var _lastScore    = 0;
      var _lastLevel    = 1;
      var _gameOverSent = false;

      function hookPhaserGame(gameEl) {
        if (_hooked) return;
        var game = gameEl.game;
        if (!game || !game.registry) return;
        _hooked = true;

        var reg = game.registry;

        // Live score tracking (optional – used for "quit & save" button)
        reg.events.on('changedata-score', function (parent, value) {
          _lastScore = value || 0;
          window.parent.postMessage({ type: 'pacman_score_update', score: _lastScore }, '*');
        });

        // Level / stage tracking
        reg.events.on('changedata-currentLevelNumber', function (parent, value) {
          _lastLevel = value || 1;
          window.parent.postMessage({ type: 'pacman_level_update', level: _lastLevel }, '*');
        });

        // Game over — the authoritative signal
        reg.events.on('changedata-currentScene', function (parent, value) {
          if (value === 'game-over' && !_gameOverSent) {
            _gameOverSent = true;
            // Give Phaser one tick to finalise the score in registry
            setTimeout(function () {
              var finalScore = reg.get('score') || _lastScore || 0;
              var finalLevel = reg.get('currentLevelNumber') || _lastLevel || 1;
              window.parent.postMessage({
                type:  'pacman_game_over',
                score: finalScore,
                level: finalLevel,
              }, '*');
            }, 50);
          }
        });

        // Also listen for registry bulk-set to catch score at game-over scene start
        reg.events.on('changedata', function (parent, key, value) {
          if (key === 'score')             _lastScore = value || 0;
          if (key === 'currentLevelNumber') _lastLevel = value || 1;
        });

        // Reset flags when a new game starts (currentScene goes to first level)
        reg.events.on('changedata-currentScene', function (parent, value) {
          if (value !== 'game-over') {
            _gameOverSent = false;
          }
        });
      }

      // Poll for <pcm-game> element and its .game property
      var _pollTimer = setInterval(function () {
        var el = document.querySelector('pcm-game');
        if (el && el.game && el.game.registry) {
          clearInterval(_pollTimer);
          hookPhaserGame(el);
        }
      }, 100);

      // Stop polling after 60s (game definitely loaded or failed)
      setTimeout(function () { clearInterval(_pollTimer); }, 60000);

      // ── 3. Expose a manual trigger for the "Quit & Save" button ─────────────
      // When user clicks QUIT in the parent page, we read the live score from
      // the game registry and post it back.
      window.__pacmanRequestScore = function () {
        var el  = document.querySelector('pcm-game');
        var reg = el && el.game && el.game.registry;
        var score = (reg && reg.get('score')) || _lastScore || 0;
        var level = (reg && reg.get('currentLevelNumber')) || _lastLevel || 1;
        window.parent.postMessage({
          type:  'pacman_game_over',
          score: score,
          level: level,
        }, '*');
      };

    }());
    </script>
</head>
<body>
    <style>
        :root { --font-stack: sans-serif; }
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: #000;
        }
    </style>
    <span aria-hidden="true" style="font-family: var(--font-stack);"></span>
    <script defer src="index.min.js"></script>
</body>
</html>
